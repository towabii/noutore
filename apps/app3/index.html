<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ocearya-ç¿»è¨³</title>
<link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§ </text></svg>">
<script src="https://cdn.jsdelivr.net/npm/qrcode@1/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<style>
  :root{
    --wood-bg: #f3d9b1;
    --wood-dark: #6f4e37;
    --panel-bg: #fdf6e8;
    --text-color: #5a3d2b;
    --accent-color: #e9c28a;
    --shadow-color: rgba(0, 0, 0, 0.2);
    --highlight-color: rgba(255, 255, 255, 0.6);
  }
  html,body{
    height:100%;
    margin:0;
    font-family: 'M PLUS Rounded 1c', "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    background-color: var(--wood-bg);
    background-image:
      linear-gradient(90deg, rgba(111, 78, 55, 0.07) 50%, transparent 50%),
      linear-gradient(rgba(111, 78, 55, 0.07) 50%, transparent 50%);
    background-size: 50px 50px;
    color: var(--text-color);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    user-select:none;
    overflow: hidden;
  }

  .container {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    width: 100%;
    position: relative;
  }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  #loader {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  .hidden {
    display: none !important;
  }

  #skipBtn {
    position: absolute;
    bottom: 20px;
    right: 20px;
    padding: 8px 16px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    z-index: 10000;
    font-weight: bold;
  }
  #skipBtn:hover {
    background: rgba(255,255,255,0.2);
  }

  /* ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ */
  #staffRollContainer {
    width: 100%;
    height: 100%;
    overflow: hidden;
    position: relative;
  }

  /* ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒªã‚¹ãƒˆ */
  .credits-list {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 700px;
    color: #e0e0e0;
    text-align: center;
    font-size: 16px;
    animation: scroll-up 14s linear forwards;
  }
  .credits-list pre {
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
    font-size: 1em;
    line-height: 1.8;
    text-align: left;
    white-space: pre-wrap;
    margin: 0;
  }

  @keyframes scroll-up {
    0% {
      top: 100%;
    }
    100% {
      top: -100%;
    }
  }

  /* ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œè¡¨ç¤º */
  #loadComplete {
    text-align: center;
    color: #fff;
    opacity: 0;
  }
  #loadComplete h1 {
    font-size: 48px;
    font-weight: 800;
    color: #fff;
    letter-spacing: 0.1em;
    text-shadow: 0 0 10px #4D96FF, 0 0 20px #4D96FF;
    margin-bottom: 8px;
  }

  /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  @keyframes fade-in {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
  @keyframes fade-out {
    from { opacity: 1; }
    to { opacity: 0; }
  }
  .fade-in { animation: fade-in 1s ease-out forwards; }
  .fade-out { animation: fade-out 1s ease-in forwards; }

  .app {
    width: 100%;
    max-width:1100px;
    margin: 20px;
    padding:0;
    display:grid;
    grid-template-columns: 1fr 320px;
    gap:20px;
    align-items:start;
    position: relative;
  }

  /* å·¦ï¼šã‚²ãƒ¼ãƒ ãƒ‘ãƒãƒ« */
  .game-panel {
    background: var(--panel-bg);
    border-radius:18px;
    padding:18px;
    box-shadow: 0 10px 20px var(--shadow-color), 0 0 0 10px var(--wood-dark), 0 0 0 12px var(--accent-color);
    position: relative;
    border: 3px solid var(--highlight-color);
  }

  .header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    margin-bottom:12px;
  }
  .title {
    font-size:24px;
    font-weight:800;
  }
  .meta .box {
    background: var(--accent-color);
    padding: 8px 12px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 16px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 2px rgba(255,255,255,0.5);
    border: 2px solid var(--text-color);
  }

  .board-wrap {
    display:flex;
    gap:18px;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  /* ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠ */
  .board {
    --game-width: 400px;
    --game-height: 500px;
    width: var(--game-width);
    height: var(--game-height);
    background-color: #f3d9b1;
    background-image: linear-gradient(rgba(111, 78, 55, 0.1) 1px, transparent 1px),
                      linear-gradient(90deg, rgba(111, 78, 55, 0.1) 1px, transparent 1px);
    background-size: 20px 20px;
    border-radius: 10px;
    box-shadow: inset 0 0 30px rgba(0,0,0,0.3);
    border: 10px solid var(--wood-dark);
    box-sizing: border-box;
    position: relative;
  }

  .board canvas {
    border-radius: 0;
  }

  .feedback-popup {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 52px;
    font-weight: 900;
    color: #fff;
    -webkit-text-stroke: 2px #d62828;
    text-shadow: 0 0 10px #f77f00, 0 0 20px #fcbf49, 0 0 30px #eae2b7;
    pointer-events: none;
    z-index: 100;
    white-space: nowrap;
    animation: feedback-popup-animation 1.2s ease-out forwards;
  }
  @keyframes feedback-popup-animation {
    0% { opacity: 1; transform: translate(-50%, -50%) scale(0.8); }
    20% { opacity: 1; transform: translate(-50%, -60%) scale(1.2); }
    100% { opacity: 0; transform: translate(-50%, -150%) scale(1.2); }
  }

  /* å³ï¼šã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
  .side {
    background: var(--panel-bg);
    border-radius: 18px;
    padding: 18px;
    box-shadow: 0 8px 16px var(--shadow-color), 0 0 0 10px var(--wood-dark), 0 0 0 12px var(--accent-color);
    display: flex;
    flex-direction: column;
    gap: 12px;
    border: 3px solid var(--highlight-color);
  }
  .side h3 { margin:0; font-size:18px; font-weight:800; text-align: center; }
  .pieces {
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:center;
  }
  .piece-card {
    background: var(--accent-color);
    padding:10px;
    border-radius: 15px;
    min-width:100px;
    min-height:100px;
    display:flex;
    align-items:center;
    justify-content:center;
    border: 4px solid var(--wood-dark);
    box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
  }

  .piece-grid {
    font-size: 50px;
    filter: drop-shadow(3px 3px 3px rgba(0,0,0,0.3));
  }
  
  button.btn {
    padding: 10px 16px;
    border-radius: 12px;
    background: linear-gradient(180deg, #f7b267, #f4845f);
    color: #fff;
    border: 3px solid var(--wood-dark);
    cursor: pointer;
    font-weight: 700;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2), inset 0 2px 2px rgba(255,255,255,0.5);
    transition: all 0.1s ease;
  }
  button.btn:active {
    transform: translateY(2px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 2px 2px rgba(255,255,255,0.5);
  }

  .scorebox {
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:space-between;
    margin-top:6px;
    font-size: 18px;
  }

  .evolution-guide {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 3px dashed var(--accent-color);
  }
  .evolution-list {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 4px;
    margin-top: 8px;
  }
  .evolution-item {
    font-size: 18px;
  }
  .evolution-arrow {
    font-size: 14px;
    color: var(--wood-dark);
  }

  
  .game-over {
    position:absolute;
    inset:10px;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(4px);
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:10px;
    z-index:40;
    pointer-events:none;
  }
  .go-card {
    background: var(--panel-bg);
    padding: 24px;
    border-radius: 15px;
    text-align: center;
    color: var(--text-color);
    pointer-events: auto;
    border: 5px solid var(--wood-dark);
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
  }

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }
  .modal-content {
    background: var(--panel-bg);
    border: 5px solid var(--wood-dark);
    border-radius: 12px;
    padding: 24px;
    width: 100%;
    max-width: 500px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    color: var(--text-color);
  }
  .modal-content h2 {
    color: var(--text-color);
    margin-top: 0;
    font-size: 20px;
    border-bottom: 2px solid var(--accent-color);
    padding-bottom: 8px;
    margin-bottom: 16px;
  }
  .modal-content .sub-header {
    font-weight: bold;
    margin-top: 16px;
    margin-bottom: 4px;
    color: var(--wood-dark);
  }
  .modal-footer { text-align: right; margin-top: 24px; }
  .password-input, .cheat-input {
    width: 100%; padding: 10px; border-radius: 6px;
    background: var(--accent-color);
    border: 2px solid var(--wood-dark);
    color: var(--text-color); font-size: 16px; margin-top: 8px; box-sizing: border-box;
  }
  
  #hamburger-icon {
    position: absolute; top: 20px; right: 20px; width: 30px; height: 22px; cursor: pointer; z-index: 1002;
    display: flex; flex-direction: column; justify-content: space-between;
  }
  #hamburger-icon span { display: block; height: 4px; width: 100%; background: var(--wood-dark); border-radius: 3px; transition: all 0.3s ease-in-out; }
  #menu-panel {
    position: fixed; top: 0; right: -300px; width: 280px; height: 100%;
    background: var(--panel-bg);
    border-left: 5px solid var(--wood-dark);
    box-shadow: -5px 0 25px rgba(0,0,0,0.5); z-index: 1001; transition: right 0.4s ease-in-out;
    padding: 80px 20px 20px; box-sizing: border-box;
  }
  #menu-panel.open { right: 0; }
  .menu-item { padding: 15px 10px; border-bottom: 2px solid var(--accent-color); color: var(--text-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
  .menu-item:hover { background: var(--accent-color); }
  .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; inset: 0; background-color: var(--accent-color); transition: .4s; border-radius: 28px; }
  .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: #f4845f; }
  input:checked + .slider:before { transform: translateX(22px); }

  #qrcode { display: flex; justify-content: center; margin: 20px 0; background: white; padding: 10px; border-radius: 8px; }
  .url-container { display: flex; gap: 8px; }
  .url-input { flex-grow: 1; padding: 8px; background: var(--accent-color); border: 2px solid var(--wood-dark); color: var(--text-color); border-radius: 6px; }

  /* å½ç¿»è¨³ã‚µã‚¤ãƒˆã¯ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´ã—ãªã„ */
  #fake-translator { position: fixed; inset: 0; background: #fff; z-index: 10000; color: #202124; font-family: 'Roboto', 'Noto Sans JP', sans-serif; display: flex; flex-direction: column; }
  .translator-header { display: flex; justify-content: flex-start; align-items: center; padding: 12px 24px; border-bottom: 1px solid #e0e0e0; }
  .translator-header .logo { font-size: 22px; font-weight: 500; color: #5f6368; display: flex; align-items: center; gap: 8px; }
  .translator-body { display: grid; grid-template-columns: 1fr auto 1fr; gap: 24px; flex-grow: 1; padding: 24px; }
  .translator-panel { border: 1px solid #dadce0; border-radius: 8px; display: flex; flex-direction: column; }
  .lang-selector-bar { display: flex; border-bottom: 1px solid #dadce0; }
  .lang-selector { padding: 12px 16px; border: none; background: none; cursor: pointer; font-weight: 500; color: #1a73e8; }
  .translator-textarea { flex-grow: 1; resize: none; border: none; padding: 16px; font-size: 18px; box-sizing: border-box; background: none; color: #202124; }
  .translator-textarea:focus { outline: none; }
  .translator-controls { display: flex; align-items: center; }
  #translate-btn { padding: 10px; background: none; border: 1px solid #dadce0; border-radius: 50%; cursor: pointer; width: 40px; height: 40px; }
  
  /* ========== é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰HUDã“ã“ã‹ã‚‰ ========== */
  #dev-hud { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: limegreen; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 12px; padding: 10px; border-radius: 8px; z-index: 9999; pointer-events: none; white-space: pre; line-height: 1.4; display: flex; gap: 20px; }
  .fps-good { color: #86efac; } .fps-warn { color: #fde047; } .fps-bad { color: #f87171; }
  .dev-controls-panel { display: flex; flex-direction: column; gap: 4px; pointer-events: auto; }
  .dev-controls-panel button { background: rgba(120, 255, 120, 0.2); border: 1px solid limegreen; color: limegreen; font-family: monospace; cursor: pointer; padding: 2px 6px; border-radius: 4px; }
  .dev-controls-panel button:hover { background: rgba(120, 255, 120, 0.4); }
  #dev-console { position: fixed; bottom: 10px; right: 10px; left: auto; width: calc(100% - 20px); max-width: 600px; height: 100px; background: rgba(10,10,20,0.8); border: 1px solid var(--accent-color); border-radius: 8px; z-index: 9998; overflow-y: auto; padding: 8px; font-family: monospace; font-size: 11px; color: #ccc; pointer-events: none; }
  #dev-console .log-error { color: #ff8080; } #dev-console .log-warn { color: #fde047; }
  /* ========== é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰HUDã“ã“ã¾ã§ ========== */

  /* ========== Sokohara Record ã“ã“ã‹ã‚‰ ========== */
  #sokohara-record { position: fixed; top: 20px; left: 50%; background: linear-gradient(45deg, #ffd700, #ff8c00); color: #000; padding: 12px 24px; border-radius: 10px; font-size: 18px; font-weight: bold; z-index: 1005; box-shadow: 0 5px 20px rgba(0,0,0,0.4); text-shadow: 1px 1px 2px rgba(255,255,255,0.3); }
  @keyframes fade-in-then-out {
      0% { opacity: 0; transform: translate(-50%, -80px); }
      15% { opacity: 1; transform: translate(-50%, 0); }
      85% { opacity: 1; transform: translate(-50%, 0); }
      100% { opacity: 0; transform: translate(-50%, -80px); }
  }
  /* ========== Sokohara Record ã“ã“ã¾ã§ ========== */

  /* small helpers */
  .note { font-size:14px; color: var(--wood-dark); }
  .muted { color: #9c7b64; font-size:14px; font-weight: 600; }
  .center { text-align:center; }
  @media (max-width:980px){
    .container { align-items: flex-start; }
    .app{ grid-template-columns: 1fr; padding: 12px; margin: 0; }
    .side{ order:2; }
    .game-panel{ order:1; }
    .board { --game-width: 90vw; --game-height: 112.5vw; max-width: 400px; max-height: 500px; }
    .piece-card { min-width: 70px; min-height: 70px; padding: 5px;}
    .piece-grid { font-size: 36px; }
    #dev-hud { font-size: 10px; flex-direction: column; }
    #dev-console { max-width: 100%; height: 80px; }
  }
</style>
</head>
<body>
  <!-- é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰HUD -->
  <div id="dev-hud" class="hidden"></div>
  <div id="dev-console" class="hidden"></div>
  <!-- Sokohara Record -->
  <div id="sokohara-record" class="hidden">åº•åŸæ°¸å’Œã®æœ€é«˜è¨˜éŒ²: 13000ç‚¹</div>

  <div class="container">
    <div id="loader">
      <button id="skipBtn">ã‚¹ã‚­ãƒƒãƒ—</button>
      <div id="staffRollContainer">
        <div class="credits-list">
          <pre>
ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼ .................. åº•åŸæ°¸å’Œ
ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ .................... åº•åŸæ°¸å’Œ
ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼ .... åº•åŸæ°¸å’Œ
ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼ ...... åº•åŸæ°¸å’Œ

ãƒ‡ã‚¶ã‚¤ãƒ³ ........................ åº•åŸæ°¸å’Œ
ã‚·ãƒŠãƒªã‚ª ........................ åº•åŸæ°¸å’Œ
ãƒ¬ãƒ™ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ .................. åº•åŸæ°¸å’Œ
ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ .................... åº•åŸæ°¸å’Œ
UI/UXãƒ‡ã‚¶ã‚¤ãƒ³ ................... åº•åŸæ°¸å’Œ

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒªãƒ¼ãƒ‰ ................ åº•åŸæ°¸å’Œ
ã‚¨ãƒ³ã‚¸ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ ............ åº•åŸæ°¸å’Œ
ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ ........ åº•åŸæ°¸å’Œ
AIãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ .................. åº•åŸæ°¸å’Œ
ãƒ„ãƒ¼ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ .............. åº•åŸæ°¸å’Œ
ã‚µã‚¦ãƒ³ãƒ‰ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ ............ åº•åŸæ°¸å’Œ
ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ ........ åº•åŸæ°¸å’Œ

ã‚¢ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ .............. åº•åŸæ°¸å’Œ
ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ .......... åº•åŸæ°¸å’Œ
ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ ............ åº•åŸæ°¸å’Œ
èƒŒæ™¯ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ .................. åº•åŸæ°¸å’Œ
UIãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ .................... åº•åŸæ°¸å’Œ
2Dã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ .................. åº•åŸæ°¸å’Œ
3Dãƒ¢ãƒ‡ãƒ©ãƒ¼ ...................... åº•åŸæ°¸å’Œ
ãƒªã‚¬ãƒ¼ .......................... åº•åŸæ°¸å’Œ
ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚¿ãƒ¼ .................... åº•åŸæ°¸å’Œ
ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ .......... åº•åŸæ°¸å’Œ
VFXã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ ................ åº•åŸæ°¸å’Œ
ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ ........ åº•åŸæ°¸å’Œ
ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ¼ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ ........ åº•åŸæ°¸å’Œ

ã‚µã‚¦ãƒ³ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ ............ åº•åŸæ°¸å’Œ
ä½œæ›² ............................ åº•åŸæ°¸å’Œ
åŠ¹æœéŸ³åˆ¶ä½œ ...................... åº•åŸæ°¸å’Œ
ãƒœã‚¤ã‚¹åéŒ² ...................... åº•åŸæ°¸å’Œ
ãƒŸã‚­ã‚·ãƒ³ã‚° ...................... åº•åŸæ°¸å’Œ

QAãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ .................. åº•åŸæ°¸å’Œ
QAãƒªãƒ¼ãƒ€ãƒ¼ ...................... åº•åŸæ°¸å’Œ
QAãƒ†ã‚¹ã‚¿ãƒ¼ ...................... åº•åŸæ°¸å’Œ

ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚ºãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ ........ åº•åŸæ°¸å’Œ
ç¿»è¨³ ............................ åº•åŸæ°¸å’Œ
ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚ºãƒ†ã‚¹ã‚¿ãƒ¼ ............ åº•åŸæ°¸å’Œ

ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ ...... åº•åŸæ°¸å’Œ
PR .............................. åº•åŸæ°¸å’Œ
ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ ........ åº•åŸæ°¸å’Œ
å…¬å¼ã‚µã‚¤ãƒˆé‹å–¶ .................. åº•åŸæ°¸å’Œ

ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚µãƒ³ã‚¯ã‚¹ .............. åº•åŸæ°¸å’Œ
          </pre>
        </div>
      </div>
      <div id="loadComplete" class="hidden">
        <h1>åº•åŸæ°¸å’Œä½œæˆ</h1>
      </div>
    </div>

    <div id="hamburger-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <div id="menu-panel">
      <div class="menu-item" id="menu-restart-btn">
        <span>ã‚„ã‚Šç›´ã™</span>
      </div>
      <div class="menu-item">
        <span>ã‚µã‚¦ãƒ³ãƒ‰</span>
        <label class="switch">
          <input type="checkbox" id="sound-toggle" checked>
          <span class="slider"></span>
        </label>
      </div>
      <div class="menu-item" id="menu-share-btn">
          <span>å…±æœ‰ã™ã‚‹</span>
      </div>
      <div class="menu-item" id="menu-dev-mode-btn">
          <span>é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰</span>
      </div>
    </div>

    <div class="app hidden" role="application" aria-label="ãƒ•ãƒ«ãƒ¼ãƒ„åˆä½“" id="appContainer">
      <div class="game-panel" id="gamePanel">
        <div class="header">
          <div class="title">ãƒ•ãƒ«ãƒ¼ãƒ„åˆä½“</div>
          <div class="meta">
            <div class="box" id="scoreBox">Score: 0</div>
            <div class="box" id="highBox">High: 0</div>
          </div>
        </div>
        <div class="board-wrap">
          <div class="board" id="board" aria-label="ç›¤é¢"></div>
        </div>
      </div>
      <aside class="side" id="side">
        <h3>æ¬¡ã®ãƒ•ãƒ«ãƒ¼ãƒ„</h3>
        <div class="pieces" id="piecesContainer" role="list"></div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div class="scorebox">
            <div class="muted">Current:</div>
            <div id="currentScore" style="font-weight:800">0</div>
          </div>
          <div class="scorebox">
            <div class="muted">Best:</div>
            <div id="bestScore" style="font-weight:800">0</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:6px;">
          <button class="btn" id="restartBtn">ã‚„ã‚Šç›´ã™</button>
        </div>
        
        <div class="evolution-guide">
          <h3>é€²åŒ–ã®é †ç•ª</h3>
          <div class="evolution-list" id="evolutionList"></div>
        </div>

        <div style="margin-top:auto">
          <div class="muted">éŠã³æ–¹</div>
          <div class="note">ç›¤é¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’è½ã¨ã—ã¾ã™ã€‚åŒã˜ãƒ•ãƒ«ãƒ¼ãƒ„åŒå£«ãŒã¶ã¤ã‹ã‚‹ã¨ã€ã‚ˆã‚Šå¤§ããªãƒ•ãƒ«ãƒ¼ãƒ„ã«é€²åŒ–ã—ã¾ã™ï¼ãƒ•ãƒ«ãƒ¼ãƒ„ãŒä¸Šã®ç·šã‹ã‚‰ã‚ãµã‚Œã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ã™ã€‚</div>
        </div>
        <div style="margin-top:12px;">
          <div class="muted">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>
          <div class="note">
              <a href="https://forms.gle/Twv47c7AG9uAM2fG6" target="_blank" rel="noopener noreferrer" style="color: var(--wood-dark);">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«ã”å”åŠ›ãã ã•ã„</a>
          </div>
          <div class="note" style="margin-top: 8px;">
              ã€ãƒ’ãƒ³ãƒˆã€‘ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§å½ã‚µã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ON/OFF
          </div>
        </div>
      </aside>
    </div>
    
    <div id="noticeModal" class="modal-overlay hidden">
      <div class="modal-content">
        <h2>ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ±</h2>
        <div class="sub-header">ä»Šå›ã®ä¿®æ­£ãƒ»è¿½åŠ </div>
        <ul>
          <li>ãƒã‚¤ã‚¹ã‚³ã‚¢ãŒä¿å­˜ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚</li>
          <li>é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ï¼‰</li>
        </ul>
        <div class="sub-header">éŠã³æ–¹</div>
        <ul>
          <li>ç›¤é¢ã®ä¸Šéƒ¨ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’è½ã¨ã—ã¾ã™ã€‚</li>
          <li>åŒã˜ç¨®é¡ã®ãƒ•ãƒ«ãƒ¼ãƒ„ãŒæ¥è§¦ã™ã‚‹ã¨ã€åˆä½“ã—ã¦å¤§ããªãƒ•ãƒ«ãƒ¼ãƒ„ã«é€²åŒ–ã—ã¾ã™ã€‚</li>
          <li>ãƒ•ãƒ«ãƒ¼ãƒ„ãŒç›¤é¢ã®ä¸Šéƒ¨ã«ã‚ã‚‹èµ¤ã„ç·šã‹ã‚‰ã‚ãµã‚Œã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ã™ã€‚</li>
        </ul>
        <div class="sub-header">æ³¨æ„</div>
        <p class="note" style="line-height: 1.6;">
          å…ˆç”Ÿã«æ³¨æ„ã•ã‚ŒãŸã‚Šã€å…ˆç”Ÿã«æ€’ã‚‰ã‚ŒãŸã‚Šã—ãŸå ´åˆã§ã‚‚åº•åŸæ°¸å’Œã¯è²¬ä»»ã‚’å–ã‚Šã¾ã›ã‚“ã€‚ã‚ã¨ã€éŸ³é‡æ³¨æ„
        </p>
        <div class="modal-footer">
          <button class="btn" id="closeNoticeBtn">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>

    <div id="cheatCodeModal" class="modal-overlay hidden">
      <div class="modal-content">
        <h2>ã‚³ãƒ¼ãƒ‰å…¥åŠ›</h2>
        <p class="note">ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        <input type="password" id="cheatInput" class="cheat-input">
        <div class="modal-footer">
          <button class="btn" id="submitCheatBtn">å®Ÿè¡Œ</button>
          <button class="btn ghost" id="closeCheatBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </div>
    
    <div id="devPasswordModal" class="modal-overlay hidden">
      <div class="modal-content">
        <h2>é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰</h2>
        <p class="note">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        <input type="password" id="devPasswordInput" class="password-input">
        <div class="modal-footer">
          <button class="btn" id="submitDevPasswordBtn">èªè¨¼</button>
          <button class="btn ghost" id="closeDevPasswordBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </div>

    <div id="shareModal" class="modal-overlay hidden">
      <div class="modal-content">
        <h2>å…±æœ‰</h2>
        <div id="qrcode"></div>
        <p class="note center">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã‹ã€ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚</p>
        <div class="url-container">
          <input type="text" id="urlInput" class="url-input" readonly>
          <button class="btn" id="copyUrlBtn">ã‚³ãƒ”ãƒ¼</button>
        </div>
        <div class="modal-footer">
          <button class="btn" id="closeShareBtn">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
    
    <div id="fake-translator" class="hidden">
      <div class="translator-header">
        <div class="logo">
          <svg focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>
          <span>ç¿»è¨³</span>
        </div>
      </div>
      <div class="translator-body">
        <div class="translator-panel">
          <div class="lang-selector-bar">
            <select class="lang-selector">
              <option>æ—¥æœ¬èª</option>
              <option>è‹±èª</option>
              <option>ä¸­å›½èª</option>
              <option>éŸ“å›½èª</option>
            </select>
          </div>
          <textarea id="translator-input" class="translator-textarea" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›"></textarea>
        </div>
        <div class="translator-controls">
          <button id="translate-btn" title="ç¿»è¨³ã™ã‚‹">â†’</button>
        </div>
        <div class="translator-panel">
          <div class="lang-selector-bar">
            <select class="lang-selector">
              <option>è‹±èª</option>
              <option>æ—¥æœ¬èª</option>
              <option>ã‚¹ãƒšã‚¤ãƒ³èª</option>
              <option>ãƒ­ã‚·ã‚¢èª</option>
            </select>
          </div>
          <textarea id="translator-output" class="translator-textarea" readonly></textarea>
        </div>
      </div>
    </div>
  </div>

  <audio id="bgmAudio" src="bgm.mp3" loop></audio>
  <audio id="pushAudio" src="push.mp3"></audio>
  <audio id="delAudio" src="del.mp3"></audio>

  <script>
  let wasSkipPressed = false;

  window.addEventListener('DOMContentLoaded', () => {
    const loader = document.getElementById('loader');
    const skipBtn = document.getElementById('skipBtn');

    const startAppSequence = () => {
        if (loader.parentNode) {
            loader.classList.add('fade-out');
            loader.addEventListener('animationend', () => {
                if (loader.parentNode) loader.remove();
                
                const noticeModal = document.getElementById('noticeModal');
                noticeModal.classList.remove('hidden');

                document.getElementById('closeNoticeBtn').addEventListener('click', () => {
                    noticeModal.classList.add('hidden');
                    showSokoharaRecord();
                }, { once: true });
            }, { once: true });
        }
    };
    
    const skipLoading = () => {
        clearTimeout(startTimer);
        startAppSequence();
    };

    let startTimer = setTimeout(startAppSequence, 14000);
    skipBtn.addEventListener('click', skipLoading);
  });

  function showSokoharaRecord() {
      const recordEl = document.getElementById('sokohara-record');
      recordEl.classList.remove('hidden');
      recordEl.style.animation = 'fade-in-then-out 5s ease-out forwards';
      recordEl.addEventListener('animationend', () => {
          recordEl.classList.add('hidden');
          recordEl.style.animation = '';
          startMainApp();
      }, { once: true });
  }

  function startMainApp() {
      const appContainer = document.getElementById('appContainer');
      appContainer.classList.remove('hidden');
      appContainer.classList.add('fade-in');
      initGame();
  }

  // ========== é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰HUDã“ã“ã‹ã‚‰ ==========
  const devHUD = {
      enabled: false,
      elements: { hud: document.getElementById('dev-hud'), console: document.getElementById('dev-console'), },
      perf: { lastTime: performance.now(), frames: 0, fps: 0, frameTime: 0, cpuUsage: 0, memory: 'N/A', drawCalls: 0 },
      progress: { score: 0, playTime: 0, startTime: performance.now(), isOver: false, fruits: 0 },
      input: { lastKey: 'N/A', mouse: { x: 0, y: 0 } },
      data: { nextFruit: 'None' },
      system: { userAgent: navigator.userAgent.substring(0, 40) + '...', windowSize: `${window.innerWidth}x${window.innerHeight}` },
      debug: { flags: { devMode: false } }
  };
  function updateDevHUD() {
      if (!devHUD.enabled) { requestAnimationFrame(updateDevHUD); return; }
      const now = performance.now(); const delta = now - devHUD.perf.lastTime;
      devHUD.perf.frameTime = delta; devHUD.perf.lastTime = now; devHUD.perf.frames++;
      if (now > (devHUD.perf.lastCalcTime || 0) + 1000) { devHUD.perf.fps = devHUD.perf.frames; devHUD.perf.frames = 0; devHUD.perf.lastCalcTime = now; }
      const targetFrameTime = 1000 / 60;
      devHUD.perf.cpuUsage = Math.min(100, (devHUD.perf.frameTime / targetFrameTime) * 100);
      devHUD.perf.memory = performance.memory ? `${(performance.memory.usedJSHeapSize / 1048576).toFixed(2)} MB` : 'N/A';
      devHUD.progress.playTime = (now - devHUD.progress.startTime) / 1000;
      const fpsClass = devHUD.perf.fps >= 55 ? 'fps-good' : devHUD.perf.fps >= 30 ? 'fps-warn' : 'fps-bad';
      const hudText = `
<div>
--[ ğŸ“Š PERFORMANCE ]---------
FPS        : <span class="${fpsClass}">${devHUD.perf.fps}</span>
Frame Time : ${devHUD.perf.frameTime.toFixed(2)} ms
CPU Usage  : ${devHUD.perf.cpuUsage.toFixed(1)} %
Memory     : ${devHUD.perf.memory}
Bodies     : ${devHUD.progress.fruits}

--[ ğŸš€ PROGRESS ]------------
Score      : ${devHUD.progress.score}
Time       : ${devHUD.progress.playTime.toFixed(1)} s
Finished   : ${devHUD.progress.isOver}

--[ ğŸ§© DATA ]----------------
Next Fruit : ${devHUD.data.nextFruit}
</div>
<div>
--[ âš™ï¸ SYSTEM ]--------------
User Agent : ${devHUD.system.userAgent}
Window Size: ${devHUD.system.windowSize}

--[ ğŸ” INPUT ]----------------
Last Key   : ${devHUD.input.lastKey}
Mouse      : ${devHUD.input.mouse.x}, ${devHUD.input.mouse.y}

--[ ğŸ DEBUG ]----------------
<div class="dev-controls-panel">
  Score Controls:
  <button data-action="set-score">Set Score</button>
</div>
</div>`;
      devHUD.elements.hud.innerHTML = hudText.trim();
      requestAnimationFrame(updateDevHUD);
  }
  function logToDevConsole(message, type = 'log') { if (!devHUD.enabled) return; const p = document.createElement('p'); p.className = `log-${type}`; p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`; devHUD.elements.console.appendChild(p); devHUD.elements.console.scrollTop = devHUD.elements.console.scrollHeight; }
  window.addEventListener('keydown', e => { devHUD.input.lastKey = e.key; });
  window.addEventListener('mousemove', e => { devHUD.input.mouse = { x: e.clientX, y: e.clientY }; });
  requestAnimationFrame(updateDevHUD);
  // ========== é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰HUDã“ã“ã¾ã§ ==========


  function initGame(){
    const { Engine, Render, Runner, World, Bodies, Composite, Events } = Matter;
    const gameContainer = document.getElementById('board');
    const WIDTH = gameContainer.clientWidth;
    const HEIGHT = gameContainer.clientHeight;
    const WALL_THICKNESS = 40;
    const GAME_OVER_LINE_Y = 80;

    const FRUITS_DATA = [
        { level: 0, radius: 12, score: 1, emoji: 'ğŸ’' }, { level: 1, radius: 16, score: 3, emoji: 'ğŸ“' }, { level: 2, radius: 22, score: 6, emoji: 'ğŸ‡' },
        { level: 3, radius: 26, score: 10, emoji: 'ğŸŠ' }, { level: 4, radius: 35, score: 15, emoji: 'ğŸ' }, { level: 5, radius: 45, score: 21, emoji: 'ğŸ' },
        { level: 6, radius: 55, score: 28, emoji: 'ğŸ‘' }, { level: 7, radius: 65, score: 36, emoji: 'ğŸ' }, { level: 8, radius: 75, score: 45, emoji: 'ğŸˆ' },
        { level: 9, radius: 85, score: 55, emoji: 'ğŸ‰' }, { level: 10, radius: 100, score: 66, emoji: 'ğŸƒ' }
    ];
    
    let engine, render, runner;
    let score = 0, best = 0, isOver = false, isSoundEnabled = true;
    let currentFruit = null, nextFruitLevel = 0;
    let disableAction = false;
    let gameOverTimeout = null;

    const scoreBox = document.getElementById('scoreBox'), highBox = document.getElementById('highBox'), currentScoreEl = document.getElementById('currentScore'), bestScoreEl = document.getElementById('bestScore'), restartBtn = document.getElementById('restartBtn'), gamePanel = document.getElementById('gamePanel'), piecesContainer = document.getElementById('piecesContainer'), cheatCodeModal = document.getElementById('cheatCodeModal'), cheatInput = document.getElementById('cheatInput'), submitCheatBtn = document.getElementById('submitCheatBtn'), closeCheatBtn = document.getElementById('closeCheatBtn'), hamburgerIcon = document.getElementById('hamburger-icon'), menuPanel = document.getElementById('menu-panel'), menuRestartBtn = document.getElementById('menu-restart-btn'), soundToggle = document.getElementById('sound-toggle'), menuShareBtn = document.getElementById('menu-share-btn'), shareModal = document.getElementById('shareModal'), qrcodeContainer = document.getElementById('qrcode'), urlInput = document.getElementById('urlInput'), copyUrlBtn = document.getElementById('copyUrlBtn'), closeShareBtn = document.getElementById('closeShareBtn'), bgmAudio = document.getElementById('bgmAudio'), pushAudio = document.getElementById('pushAudio'), delAudio = document.getElementById('delAudio'), evolutionListEl = document.getElementById('evolutionList');
    const fakeTranslator = document.getElementById('fake-translator'), translateBtn = document.getElementById('translate-btn'), translatorInput = document.getElementById('translator-input'), translatorOutput = document.getElementById('translator-output');
    const menuDevModeBtn = document.getElementById('menu-dev-mode-btn');
    
    function setupPhysics() {
        engine = Engine.create({ timing: { timeScale: 1.1 } });
        render = Render.create({ element: gameContainer, engine: engine, options: { width: WIDTH, height: HEIGHT, wireframes: false, background: 'transparent', pixelRatio: window.devicePixelRatio, } });
        runner = Runner.create();
        const wallOptions = { isStatic: true, render: { visible: false } };
        const ground = Bodies.rectangle(WIDTH / 2, HEIGHT + (WALL_THICKNESS / 2) - 10, WIDTH, WALL_THICKNESS, wallOptions);
        const leftWall = Bodies.rectangle(-(WALL_THICKNESS / 2) + 10, HEIGHT / 2, WALL_THICKNESS, HEIGHT, wallOptions);
        const rightWall = Bodies.rectangle(WIDTH + (WALL_THICKNESS / 2) - 10, HEIGHT / 2, WALL_THICKNESS, HEIGHT, wallOptions);
        World.add(engine.world, [ground, leftWall, rightWall]);
        Events.on(render, 'afterRender', () => {
            const context = render.context;
            context.strokeStyle = 'rgba(255, 0, 0, 0.7)'; context.lineWidth = 3; context.setLineDash([10, 5]);
            context.beginPath(); context.moveTo(0, GAME_OVER_LINE_Y); context.lineTo(WIDTH, GAME_OVER_LINE_Y); context.stroke();
            context.setLineDash([]);
        });
        Render.run(render); Runner.run(runner, engine);
    }
    
    function createFruit(x, y, level, isStatic = false) {
        const data = FRUITS_DATA[level];
        return Bodies.circle(x, y, data.radius, { isStatic: isStatic, restitution: 0.3, friction: 0.2, label: 'fruit', fruitLevel: level, render: { sprite: { texture: createEmojiTexture(data.emoji, data.radius * 2.2), xScale: 1, yScale: 1 } } });
    }
    
    const emojiCanvasCache = {};
    function createEmojiTexture(emoji, size) {
        const cacheKey = `${emoji}_${size}`;
        if (emojiCanvasCache[cacheKey]) return emojiCanvasCache[cacheKey];
        const canvas = document.createElement('canvas'); canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.font = `${size * 0.85}px sans-serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.filter = 'drop-shadow(3px 3px 3px rgba(0,0,0,0.3))';
        ctx.fillText(emoji, size / 2, size / 2 + size * 0.05);
        return (emojiCanvasCache[cacheKey] = canvas.toDataURL());
    }

    function prepareNextFruit() {
        nextFruitLevel = Math.floor(Math.random() * 5);
        currentFruit = createFruit(WIDTH / 2, 40, nextFruitLevel, true);
        World.add(engine.world, currentFruit);
        renderNextFruit();
    }
    
    function renderNextFruit() {
        piecesContainer.innerHTML = ''; const data = FRUITS_DATA[nextFruitLevel];
        const card = document.createElement('div'); card.className = 'piece-card';
        const mini = document.createElement('div'); mini.className = 'piece-grid'; mini.textContent = data.emoji;
        card.appendChild(mini); piecesContainer.appendChild(card);
        if (devHUD.enabled) devHUD.data.nextFruit = data.emoji;
    }

    function updateScoreDisplay() {
      scoreBox.textContent = `Score: ${score}`; currentScoreEl.textContent = score;
      highBox.textContent = `High: ${best}`; bestScoreEl.textContent = best;
      if (devHUD.enabled) { devHUD.progress.score = score; }
    }
    
    function dropFruit(x) {
        if (isOver || disableAction || !currentFruit) return;
        if (isSoundEnabled) { pushAudio.currentTime = 0; pushAudio.play().catch(()=>{}); }
        const radius = FRUITS_DATA[currentFruit.fruitLevel].radius;
        const constrainedX = Math.max(radius + 10, Math.min(WIDTH - radius - 10, x));
        Matter.Body.setStatic(currentFruit, false);
        Matter.Body.setPosition(currentFruit, { x: constrainedX, y: currentFruit.position.y });
        currentFruit = null; disableAction = true;
        setTimeout(() => { prepareNextFruit(); disableAction = false; }, 500);
    }

    function handleCollisions(event) {
        const pairs = event.pairs;
        pairs.forEach(pair => {
            const { bodyA, bodyB } = pair;
            if (bodyA.label === 'fruit' && bodyB.label === 'fruit' && bodyA.fruitLevel === bodyB.fruitLevel) {
                const level = bodyA.fruitLevel;
                if (level < FRUITS_DATA.length - 1) {
                    World.remove(engine.world, [bodyA, bodyB]);
                    const nextLevel = level + 1;
                    const newX = (bodyA.position.x + bodyB.position.x) / 2;
                    const newY = (bodyA.position.y + bodyB.position.y) / 2;
                    const newFruit = createFruit(newX, newY, nextLevel);
                    Matter.Body.scale(newFruit, 0.7, 0.7);
                    World.add(engine.world, newFruit);
                    setTimeout(() => { Matter.Body.scale(newFruit, 1 / 0.7, 1 / 0.7); }, 50);
                    if (isSoundEnabled) { delAudio.currentTime = 0; delAudio.play().catch(()=>{}); }
                    const gainedScore = FRUITS_DATA[level].score; score += gainedScore;
                    updateScoreDisplay(); showFeedbackPopup(`+${gainedScore}`);
                }
            }
        });
    }

    function checkGameOver() {
        const fruits = Composite.allBodies(engine.world).filter(b => b.label === 'fruit' && !b.isStatic);
        if (devHUD.enabled) devHUD.progress.fruits = fruits.length;
        let isFruitAboveLine = false;
        for (const fruit of fruits) {
            if (fruit.speed < 0.1 && fruit.angularSpeed < 0.1 && fruit.position.y - FRUITS_DATA[fruit.fruitLevel].radius < GAME_OVER_LINE_Y) {
                isFruitAboveLine = true; break;
            }
        }
        if (isFruitAboveLine) {
            if (!gameOverTimeout) {
                gameOverTimeout = setTimeout(() => {
                    isOver = true;
                    if (devHUD.enabled) devHUD.progress.isOver = true;
                    Runner.stop(runner);
                    if (score > best) { saveBest(); }
                    showEndScreen();
                }, 2000);
            }
        } else { clearTimeout(gameOverTimeout); gameOverTimeout = null; }
    }

    function showEndScreen(){
        const overlay = document.createElement('div'); overlay.className = 'game-over'; overlay.id = 'gameOverOverlay';
        overlay.innerHTML = `<div class="go-card"><div style="font-size:24px;font-weight:800;margin-bottom:8px">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼</div><div style="margin-bottom:16px; font-size: 20px;">Score: <strong>${score}</strong></div><div style="display:flex;gap:8px;justify-content:center"><button class="btn" id="goRestart">ã‚„ã‚Šç›´ã™</button></div></div>`;
        gamePanel.appendChild(overlay);
        document.getElementById('goRestart').addEventListener('click', ()=>{ overlay.remove(); startNewSession(); });
    }

    function startNewSession(){
      score = 0; isOver = false;
      if (devHUD.enabled) { devHUD.progress.isOver = false; devHUD.progress.startTime = performance.now(); }
      updateScoreDisplay();
      World.clear(engine.world, false); Composite.clear(engine.world, false);
      const wallOptions = { isStatic: true, render: { visible: false } };
      const ground = Bodies.rectangle(WIDTH / 2, HEIGHT + (WALL_THICKNESS / 2) - 10, WIDTH, WALL_THICKNESS, wallOptions);
      const leftWall = Bodies.rectangle(-(WALL_THICKNESS / 2) + 10, HEIGHT / 2, WALL_THICKNESS, HEIGHT, wallOptions);
      const rightWall = Bodies.rectangle(WIDTH + (WALL_THICKNESS / 2) - 10, HEIGHT / 2, WALL_THICKNESS, HEIGHT, wallOptions);
      World.add(engine.world, [ground, leftWall, rightWall]);
      prepareNextFruit();
      const overlay = document.getElementById('gameOverOverlay'); if(overlay) overlay.remove();
      menuPanel.classList.remove('open');
      Runner.start(runner, engine);
    }
    
    function setupMouseControl() {
        gameContainer.addEventListener('mousemove', (e) => {
            if (isOver || disableAction || !currentFruit) return;
            const rect = gameContainer.getBoundingClientRect(); const x = e.clientX - rect.left;
            const radius = FRUITS_DATA[currentFruit.fruitLevel].radius;
            const constrainedX = Math.max(radius + 10, Math.min(WIDTH - radius - 10, x));
            Matter.Body.setPosition(currentFruit, { x: constrainedX, y: currentFruit.position.y });
        });
        gameContainer.addEventListener('click', (e) => { const rect = gameContainer.getBoundingClientRect(); const x = e.clientX - rect.left; dropFruit(x); });
    }

    function showFeedbackPopup(text){ const popup = document.createElement('div'); popup.textContent = text; popup.className = 'feedback-popup'; gamePanel.appendChild(popup); popup.addEventListener('animationend', () => popup.remove()); }
    function saveBest(){ best = Math.max(best, score); try { localStorage.setItem('fruitfall_high', String(best)); } catch(e){} updateScoreDisplay(); }
    function loadBest(){ try{ best = Number(localStorage.getItem('fruitfall_high')) || 0; } catch(e){ best = 0; } }
    function handleCheatCode() { const code = cheatInput.value.trim().toLowerCase(); if (code === 'towa.soko0406') { const newScoreStr = prompt('æ–°ã—ã„ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', score); const newScore = parseInt(newScoreStr, 10); if (!isNaN(newScore)) { score = newScore; updateScoreDisplay(); saveBest(); } else { alert('ç„¡åŠ¹ãªæ•°å€¤ã§ã™ã€‚'); } } else if (code === 'reset') { try { localStorage.removeItem('fruitfall_high'); localStorage.removeItem('blockblast_sound'); alert('ä¿å­˜ã•ã‚ŒãŸå…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚'); location.reload(); } catch (e) { alert('ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); } } else { alert('ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚'); } cheatInput.value = ''; cheatCodeModal.classList.add('hidden'); }
    function showFakeTranslator() { fakeTranslator.classList.remove('hidden'); }
    function hideFakeTranslator() { fakeTranslator.classList.add('hidden'); }
    function simpleTranslate(text) { const map = {a:'b',b:'c',d:'e',f:'g',h:'i',j:'k',l:'m',n:'o',p:'q',r:'s',t:'u',v:'w',x:'y',z:'a', 'ã‚':'ã„','ã„':'ã†','ã†':'ãˆ','ãˆ':'ãŠ','ãŠ':'ã‹','ã‹':'ã','ã':'ã','ã':'ã‘','ã‘':'ã“','ã“':'ã•'}; return text.toLowerCase().split('').map(char => map[char] || char).join(''); }
    
    function init(){
      loadBest();
      setupPhysics();
      prepareNextFruit();
      updateScoreDisplay();
      setupMouseControl();
      Events.on(engine, 'collisionStart', handleCollisions);
      Events.on(engine, 'afterUpdate', checkGameOver);
      evolutionListEl.innerHTML = FRUITS_DATA.map(f => `<span class="evolution-item">${f.emoji}</span>`).join('<span class="evolution-arrow">â†’</span>');

      restartBtn.addEventListener('click', startNewSession);
      closeCheatBtn.addEventListener('click', () => cheatCodeModal.classList.add('hidden'));
      submitCheatBtn.addEventListener('click', handleCheatCode); cheatInput.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') handleCheatCode(); });
      hamburgerIcon.addEventListener('click', () => { menuPanel.classList.toggle('open'); }); menuRestartBtn.addEventListener('click', startNewSession);
      const savedSoundSetting = localStorage.getItem('blockblast_sound');
      if (savedSoundSetting !== null) { isSoundEnabled = savedSoundSetting === 'true'; soundToggle.checked = isSoundEnabled; }
      const playBGM = () => { if(isSoundEnabled) bgmAudio.play().catch(()=>{}); };
      document.body.addEventListener('click', playBGM, { once: true });
      soundToggle.addEventListener('change', (e) => { isSoundEnabled = e.target.checked; try { localStorage.setItem('blockblast_sound', isSoundEnabled); } catch(err) {} if (isSoundEnabled) { bgmAudio.play().catch(()=>{}); } else { bgmAudio.pause(); } });
      menuShareBtn.addEventListener('click', () => { const url = `${window.location.origin}${window.location.pathname}`; urlInput.value = url; qrcodeContainer.innerHTML = ''; QRCode.toCanvas(url, { width: 200, errorCorrectionLevel: 'H' }, (err, canvas) => { if (err) throw err; qrcodeContainer.appendChild(canvas); }); shareModal.classList.remove('hidden'); menuPanel.classList.remove('open'); });
      closeShareBtn.addEventListener('click', () => shareModal.classList.add('hidden')); copyUrlBtn.addEventListener('click', () => { urlInput.select(); navigator.clipboard.writeText(urlInput.value).then(() => { copyUrlBtn.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†!'; setTimeout(() => { copyUrlBtn.textContent = 'ã‚³ãƒ”ãƒ¼'; }, 2000); }); });
      
      const originalTitle = document.title, favicon = document.getElementById('favicon'), originalFavicon = favicon ? favicon.href : ''; const fakeTitle = 'ç¿»è¨³', fakeFavicon = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ</text></svg>';
      window.addEventListener('blur', () => { document.title = fakeTitle; if(favicon) favicon.href = fakeFavicon; }); window.addEventListener('focus', () => { document.title = originalTitle; if(favicon) favicon.href = originalFavicon; });
      translateBtn.addEventListener('click', () => { translatorOutput.value = simpleTranslate(translatorInput.value); });
      
      window.addEventListener('keydown', (ev)=>{
        if (ev.key === 'Enter' && !ev.target.closest('.modal-overlay') && ev.target.tagName !== 'TEXTAREA') { ev.preventDefault(); if (fakeTranslator.classList.contains('hidden')) { showFakeTranslator(); } else { hideFakeTranslator(); } }
        if (document.querySelector('.modal-overlay:not(.hidden)')) return;
        if(ev.key === ' ') { ev.preventDefault(); cheatCodeModal.classList.remove('hidden'); cheatInput.focus(); }
        if(ev.key.toLowerCase() === 'r') startNewSession();
      });

      setupDevMode();
    }
    
    function setupDevMode() {
        const devPasswordModal = document.getElementById('devPasswordModal'), devPasswordInput = document.getElementById('devPasswordInput'), submitDevPasswordBtn = document.getElementById('submitDevPasswordBtn'), closeDevPasswordBtn = document.getElementById('closeDevPasswordBtn');
        if (menuDevModeBtn) menuDevModeBtn.addEventListener('click', () => { devPasswordModal.classList.remove('hidden'); devPasswordInput.focus(); menuPanel.classList.remove('open'); });
        if (closeDevPasswordBtn) closeDevPasswordBtn.addEventListener('click', () => devPasswordModal.classList.add('hidden'));
        if (submitDevPasswordBtn) {
            submitDevPasswordBtn.addEventListener('click', handleDevPassword);
            devPasswordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleDevPassword(); });
        }
        devHUD.elements.hud.addEventListener('click', (e) => {
            if (!devHUD.enabled || e.target.dataset.action !== 'set-score') return;
            const newScoreStr = prompt('æ–°ã—ã„ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', score);
            const newScore = parseInt(newScoreStr, 10);
            if (!isNaN(newScore) && newScore >= 0) { score = newScore; logToDevConsole(`Score changed to ${score}`); updateScoreDisplay(); saveBest(); } 
            else { alert('ç„¡åŠ¹ãªæ•°å€¤ã§ã™ã€‚'); }
        });
    }

    function handleDevPassword() {
        const devPasswordInput = document.getElementById('devPasswordInput'), devPasswordModal = document.getElementById('devPasswordModal');
        const password = devPasswordInput.value.trim();
        if (password === 'towa.soko0406') {
            devHUD.enabled = !devHUD.enabled;
            if (devHUD.enabled) { devHUD.elements.hud.classList.remove('hidden'); devHUD.elements.console.classList.remove('hidden'); alert('é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚'); logToDevConsole('Developer mode enabled.'); } 
            else { devHUD.elements.hud.classList.add('hidden'); devHUD.elements.console.classList.add('hidden'); alert('é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚'); }
        } else if (password === 'reset') {
            if (confirm('æœ¬å½“ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                try { localStorage.removeItem('fruitfall_high'); localStorage.removeItem('blockblast_sound'); alert('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚'); location.reload(); } 
                catch (e) { alert('ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); logToDevConsole('Failed to reset data.', 'error'); }
            }
        } else { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚'); }
        devPasswordModal.classList.add('hidden');
        devPasswordInput.value = '';
    }

    init();
  }
  </script>
</body>
</html>
