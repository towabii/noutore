<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å¾³å·å®¶åº·ã®æ­´å²ã«ã¤ã„ã¦</title>
<link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§ </text></svg>">
<script src="https://cdn.jsdelivr.net/npm/qrcode@1/build/qrcode.min.js"></script>
<style>
  :root{
    --bg:#0f1724;
    --panel:#0b1220;
    --accent:#1f2937;
    --cell:#0b1226;
    --cell-border:rgba(255,255,255,0.04);
    --tile-size:56px; /* åŸºæœ¬ã‚»ãƒ«ã‚µã‚¤ã‚ºï¼ˆPCå‘ã‘ï¼‰ã€‚å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ */
  }
  html,body{
    height:100%;
    margin:0;
    font-family: Inter, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    background:linear-gradient(180deg, #031026 0%, #081426 100%);
    color:#e6eef8;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    user-select:none;
    overflow: hidden; /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ */
  }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  #loader {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  .hidden {
    display: none !important;
  }

  #skipBtn {
    position: absolute;
    bottom: 20px;
    right: 20px;
    padding: 8px 16px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    z-index: 10000;
    font-weight: bold;
  }
  #skipBtn:hover {
    background: rgba(255,255,255,0.2);
  }

  /* ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ */
  #staffRollContainer {
    width: 100%;
    height: 100%;
    overflow: hidden;
    position: relative;
  }

  /* ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒªã‚¹ãƒˆ */
  .credits-list {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 700px;
    color: #e0e0e0;
    text-align: center;
    font-size: 16px;
    animation: scroll-up 14s linear forwards;
  }
  .credits-list pre {
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
    font-size: 1em;
    line-height: 1.8;
    text-align: left;
    white-space: pre-wrap;
    margin: 0;
  }

  @keyframes scroll-up {
    0% {
      top: 100%;
    }
    100% {
      top: -100%;
    }
  }

  /* ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œè¡¨ç¤º */
  #loadComplete {
    text-align: center;
    color: #fff;
    opacity: 0;
  }
  #loadComplete h1 {
    font-size: 48px;
    font-weight: 800;
    color: #fff;
    letter-spacing: 0.1em;
    text-shadow: 0 0 10px #4D96FF, 0 0 20px #4D96FF;
    margin-bottom: 8px;
  }

  /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  @keyframes fade-in {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
  @keyframes fade-out {
    from { opacity: 1; }
    to { opacity: 0; }
  }
  .fade-in { animation: fade-in 1s ease-out forwards; }
  .fade-out { animation: fade-out 1s ease-in forwards; }

  .app {
    max-width:1100px;
    margin:28px auto;
    padding:20px;
    display:grid;
    grid-template-columns: 1fr 320px;
    gap:20px;
    align-items:start;
    position: relative;
  }

  /* å·¦ï¼šãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‘ãƒãƒ« */
  .game-panel {
    background:var(--panel);
    border-radius:12px;
    padding:18px;
    box-shadow: 0 6px 24px rgba(2,6,23,0.6);
    position: relative;
    overflow: hidden;
  }

  .header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    margin-bottom:12px;
  }
  .title {
    font-size:20px;
    font-weight:700;
    letter-spacing:0.4px;
  }
  .meta {
    display:flex;
    gap:8px;
    align-items:center;
  }
  .meta .box {
    background:var(--accent);
    padding:8px 10px;
    border-radius:8px;
    font-weight:600;
    font-size:14px;
  }

  /* ã‚°ãƒªãƒƒãƒ‰ */
  .board-wrap {
    display:flex;
    gap:18px;
  }

  .board {
    width: calc(var(--tile-size) * 8);
    height: calc(var(--tile-size) * 8);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:10px;
    border: 2px solid rgba(255, 255, 255, 0.8);
    padding:6px;
    box-sizing:border-box;
    display:grid;
    grid-template-columns: repeat(8, 1fr);
    grid-template-rows: repeat(8, 1fr);
    gap:4px;
    position:relative;
  }

  .cell{
    background:var(--cell);
    border:1px solid var(--cell-border);
    border-radius:6px;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:transform 0.12s ease, box-shadow 0.12s ease, background-color 0.12s ease;
    position:relative;
    overflow:visible;
  }
  .cell.hover-invalid { outline: 2px dashed rgba(255,100,100,0.18); }
  .cell.hover-valid { outline: 2px dashed rgba(100,255,150,0.18); }

  .tile {
    width:calc(100% - 8px);
    height:calc(100% - 8px);
    border-radius:4px;
    transition:transform .15s ease;
    box-shadow: 0 3px 8px rgba(2,8,20,0.5), inset 0 -2px 6px rgba(255,255,255,0.02);
  }
  
  .tile.clearing {
    animation: block-clear-animation 0.5s ease-out forwards;
  }
  @keyframes block-clear-animation {
    0% { transform: scale(1.05); filter: brightness(2.5); box-shadow: 0 0 15px 5px rgba(255, 255, 255, 0.7); }
    50% { transform: scale(1.2) rotateZ(15deg); opacity: 1; filter: brightness(1.5); }
    100% { transform: scale(0.1) rotateZ(-30deg) translateY(50px); opacity: 0; filter: brightness(5); }
  }

  .feedback-popup {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    font-weight: 900;
    color: #fff;
    text-shadow: 0 0 10px #FFD166, 0 0 20px #FF6B6B, 0 0 30px #06D6A0;
    pointer-events: none;
    z-index: 100;
    white-space: nowrap;
    animation: feedback-popup-animation 1.2s ease-out forwards;
  }
  @keyframes feedback-popup-animation {
    0% { opacity: 1; transform: translate(-50%, -50%) scale(0.8); }
    20% { opacity: 1; transform: translate(-50%, -60%) scale(1.2); }
    100% { opacity: 0; transform: translate(-50%, -150%) scale(1.2); }
  }

  /* å³ï¼šã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
  .side {
    background:var(--panel);
    border-radius:12px;
    padding:18px;
    box-shadow: 0 6px 24px rgba(2,6,23,0.6);
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .side h3 { margin:0; font-size:15px; font-weight:700; }
  .pieces {
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:flex-start;
  }
  .piece-card {
    background:var(--accent);
    padding:10px;
    border-radius:10px;
    min-width:86px;
    min-height:86px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:transform .12s ease, box-shadow .12s ease;
    outline: 2px solid transparent;
  }
  .piece-card.selected {
    transform:translateY(-6px) scale(1.02);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    outline-color: rgba(120,180,255,0.14);
  }

  .piece-grid {
    display:grid;
    grid-template-columns: repeat(4, 15px);
    grid-auto-rows: 15px;
    gap: 2px;
    align-items: center;
    justify-items: center;
  }
  .mini-cell { width:15px; height:15px; border-radius:3px; background:transparent; }
  .mini-cell.tile { width:14px; height:14px; border-radius:3px; }

  button.btn {
    padding:8px 12px;
    border-radius:8px;
    background:linear-gradient(180deg,#1f2937,#111827);
    color:#e6eef8;
    border:1px solid rgba(255,255,255,0.04);
    cursor:pointer;
    font-weight:700;
  }
  button.btn.ghost {
    background:transparent;
    border:1px dashed rgba(255,255,255,0.04);
  }

  .scorebox {
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:space-between;
    margin-top:6px;
  }

  .game-over {
    position:absolute;
    inset:0;
    background: linear-gradient(0deg, rgba(2,6,23,0.75), rgba(2,6,23,0.5));
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:10px;
    z-index:40;
    pointer-events:none;
  }
  .go-card {
    background:rgba(3,7,18,0.9);
    padding:18px;
    border-radius:10px;
    text-align:center;
    color:#fff;
    pointer-events:auto;
  }

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }
  .modal-content {
    background: var(--panel);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 24px;
    width: 100%;
    max-width: 500px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  }
  .modal-content h2 {
    margin-top: 0;
    font-size: 20px;
    border-bottom: 1px solid var(--accent);
    padding-bottom: 8px;
    margin-bottom: 16px;
  }
  .modal-content ul {
    padding-left: 20px;
    line-height: 1.7;
  }
  .modal-content .sub-header {
    font-weight: bold;
    margin-top: 16px;
    margin-bottom: 4px;
    color: #a0b0d0;
  }
  .modal-footer {
    text-align: right;
    margin-top: 24px;
  }
  .cheat-input {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    background: var(--accent);
    border: 1px solid rgba(255,255,255,0.1);
    color: #fff;
    font-size: 16px;
    margin-top: 8px;
    box-sizing: border-box;
  }
  
  #hamburger-icon {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 30px;
    height: 22px;
    cursor: pointer;
    z-index: 1002;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  #hamburger-icon span {
    display: block;
    height: 3px;
    width: 100%;
    background: #e6eef8;
    border-radius: 3px;
    transition: all 0.3s ease-in-out;
  }
  #menu-panel {
    position: fixed;
    top: 0;
    right: -300px;
    width: 280px;
    height: 100%;
    background: var(--panel);
    box-shadow: -5px 0 25px rgba(0,0,0,0.5);
    z-index: 1001;
    transition: right 0.4s ease-in-out;
    padding: 80px 20px 20px;
    box-sizing: border-box;
  }
  #menu-panel.open { right: 0; }
  .menu-item {
    padding: 15px 10px;
    border-bottom: 1px solid var(--accent);
    color: #e6eef8;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .menu-item:hover { background: var(--accent); }
  .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; inset: 0; background-color: #334155; transition: .4s; border-radius: 28px; }
  .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: #4D96FF; }
  input:checked + .slider:before { transform: translateX(22px); }

  #qrcode {
    display: flex;
    justify-content: center;
    margin: 20px 0;
    background: white;
    padding: 10px;
    border-radius: 8px;
  }
  .url-container { display: flex; gap: 8px; }
  .url-input {
    flex-grow: 1;
    padding: 8px;
    background: var(--accent);
    border: 1px solid rgba(255,255,255,0.1);
    color: #e6eef8;
    border-radius: 6px;
  }

  #ranking-table-container {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 16px;
  }
  #ranking-table {
    width: 100%;
    border-collapse: collapse;
  }
  #ranking-table th, #ranking-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid var(--accent);
  }
  #ranking-table th {
    font-weight: bold;
    position: sticky;
    top: 0;
    background: var(--panel);
  }
  #ranking-table td:nth-child(1) { width: 50px; text-align: center; }
  #ranking-table td:nth-child(3) { text-align: right; font-weight: bold; }
  #ranking-table tr.my-rank {
    background-color: rgba(77, 150, 255, 0.2);
  }

  /* small helpers */
  .note { font-size:13px; color: #9fb0d3; }
  .muted { color: #7e96b6; font-size:13px; }
  .center { text-align:center; }
  @media (max-width:980px){
    .app{ grid-template-columns: 1fr; padding:12px; }
    .side{ order:2; }
    .game-panel{ order:1; }
  }
</style>
</head>
<body>
  <div id="loader">
    <button id="skipBtn">ã‚¹ã‚­ãƒƒãƒ—</button>
    <div id="staffRollContainer">
      <div class="credits-list">
        <!-- â˜…â˜…â˜… ä¿®æ­£ç‚¹: ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ãƒ¼ãƒ«ã‚’çœç•¥ã›ãšã«å…¨æ–‡è¡¨ç¤º â˜…â˜…â˜… -->
        <pre>
ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼ .................. åº•åŸæ°¸å’Œ
ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ .................... åº•åŸæ°¸å’Œ
ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼ .... åº•åŸæ°¸å’Œ
ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼ ...... åº•åŸæ°¸å’Œ

ãƒ‡ã‚¶ã‚¤ãƒ³ ........................ åº•åŸæ°¸å’Œ
ã‚·ãƒŠãƒªã‚ª ........................ åº•åŸæ°¸å’Œ
ãƒ¬ãƒ™ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ .................. åº•åŸæ°¸å’Œ
ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ .................... åº•åŸæ°¸å’Œ
UI/UXãƒ‡ã‚¶ã‚¤ãƒ³ ................... åº•åŸæ°¸å’Œ

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒªãƒ¼ãƒ‰ ................ åº•åŸæ°¸å’Œ
ã‚¨ãƒ³ã‚¸ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ ............ åº•åŸæ°¸å’Œ
ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ ........ åº•åŸæ°¸å’Œ
AIãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ .................. åº•åŸæ°¸å’Œ
ãƒ„ãƒ¼ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ .............. åº•åŸæ°¸å’Œ
ã‚µã‚¦ãƒ³ãƒ‰ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ ............ åº•åŸæ°¸å’Œ
ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ ........ åº•åŸæ°¸å’Œ

ã‚¢ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ .............. åº•åŸæ°¸å’Œ
ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ .......... åº•åŸæ°¸å’Œ
ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ ............ åº•åŸæ°¸å’Œ
èƒŒæ™¯ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ .................. åº•åŸæ°¸å’Œ
UIãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ .................... åº•åŸæ°¸å’Œ
2Dã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ .................. åº•åŸæ°¸å’Œ
3Dãƒ¢ãƒ‡ãƒ©ãƒ¼ ...................... åº•åŸæ°¸å’Œ
ãƒªã‚¬ãƒ¼ .......................... åº•åŸæ°¸å’Œ
ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚¿ãƒ¼ .................... åº•åŸæ°¸å’Œ
ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ .......... åº•åŸæ°¸å’Œ
VFXã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ ................ åº•åŸæ°¸å’Œ
ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ ........ åº•åŸæ°¸å’Œ
ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ¼ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ ........ åº•åŸæ°¸å’Œ

ã‚µã‚¦ãƒ³ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ ............ åº•åŸæ°¸å’Œ
ä½œæ›² ............................ åº•åŸæ°¸å’Œ
åŠ¹æœéŸ³åˆ¶ä½œ ...................... åº•åŸæ°¸å’Œ
ãƒœã‚¤ã‚¹åéŒ² ...................... åº•åŸæ°¸å’Œ
ãƒŸã‚­ã‚·ãƒ³ã‚° ...................... åº•åŸæ°¸å’Œ

QAãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ .................. åº•åŸæ°¸å’Œ
QAãƒªãƒ¼ãƒ€ãƒ¼ ...................... åº•åŸæ°¸å’Œ
QAãƒ†ã‚¹ã‚¿ãƒ¼ ...................... åº•åŸæ°¸å’Œ

ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚ºãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ ........ åº•åŸæ°¸å’Œ
ç¿»è¨³ ............................ åº•åŸæ°¸å’Œ
ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚ºãƒ†ã‚¹ã‚¿ãƒ¼ ............ åº•åŸæ°¸å’Œ

ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ ...... åº•åŸæ°¸å’Œ
PR .............................. åº•åŸæ°¸å’Œ
ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ ........ åº•åŸæ°¸å’Œ
å…¬å¼ã‚µã‚¤ãƒˆé‹å–¶ .................. åº•åŸæ°¸å’Œ

ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚µãƒ³ã‚¯ã‚¹ .............. åº•åŸæ°¸å’Œ
        </pre>
      </div>
    </div>
    <div id="loadComplete" class="hidden">
      <h1>åº•åŸæ°¸å’Œä½œæˆ</h1>
    </div>
  </div>

  <div id="hamburger-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
  <div id="menu-panel">
    <div class="menu-item" id="menu-restart-btn">
      <span>ã‚„ã‚Šç›´ã™</span>
      <span>&#x21BB;</span>
    </div>
    <div class="menu-item">
      <span>ã‚µã‚¦ãƒ³ãƒ‰</span>
      <label class="switch">
        <input type="checkbox" id="sound-toggle" checked>
        <span class="slider"></span>
      </label>
    </div>
    <div class="menu-item" id="menu-ranking-btn">
      <span>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
      <span>&#x1F3C6;</span>
    </div>
    <div class="menu-item" id="menu-share-btn">
        <span>å…±æœ‰ã™ã‚‹</span>
        <span>&#x2197;</span>
    </div>
  </div>

  <div class="app hidden" role="application" aria-label="ãƒ–ãƒ­ãƒƒã‚¯è„³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°" id="appContainer">
    <div class="game-panel" id="gamePanel">
      <div class="header">
        <div class="title">ãƒ–ãƒ­ãƒƒã‚¯è„³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</div>
        <div class="meta">
          <div class="box" id="scoreBox">Score: 0</div>
          <div class="box" id="highBox">High: 0</div>
        </div>
      </div>
      <div class="board-wrap">
        <div class="board" id="board" aria-label="ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç›¤"></div>
        <div style="display:flex;flex-direction:column;gap:10px;width:220px;">
          <div class="note">æ“ä½œæ–¹æ³•: å³å´ã®ãƒ”ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ç›¤é¢ã®ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é…ç½®</div>
          <div class="note">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: ãƒ”ãƒ¼ã‚¹é¸æŠä¸­ã«ã‚»ãƒ«ã«ãƒã‚¦ã‚¹ã‚’ä¹—ã›ã‚‹ã¨ç½®ã‘ã‚‹ã‹é€éã§è¡¨ç¤º</div>
          <div class="note muted">å›è»¢ã¯ç„¡ã—ï¼ˆå¿…è¦ãªã‚‰è¿½åŠ å¯ï¼‰</div>
        </div>
      </div>
    </div>
    <aside class="side" id="side">
      <h3>Available Pieces</h3>
      <div class="pieces" id="piecesContainer" role="list"></div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div class="scorebox">
          <div class="muted">Current:</div>
          <div id="currentScore" style="font-weight:800">0</div>
        </div>
        <div class="scorebox">
          <div class="muted">Best:</div>
          <div id="bestScore" style="font-weight:800">0</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:6px;">
        <button class="btn" id="restartBtn">ã‚„ã‚Šç›´ã™</button>
        <button class="btn ghost" id="hintBtn">ãƒ’ãƒ³ãƒˆ</button>
      </div>
      <div style="margin-top:auto">
        <div class="muted">éŠã³æ–¹</div>
        <div class="note">è¡Œã¾ãŸã¯åˆ—ãŒåŸ‹ã¾ã‚‹ã¨æ¶ˆãˆã‚‹ã€‚1åˆ— = 100ç‚¹ã€‚è¤‡æ•°åŒæ™‚æ¶ˆå»ã¯ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ã€‚</div>
      </div>
      <div style="margin-top:12px;">
        <div class="muted">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>
        <div class="note">
            <a href="https://forms.gle/Twv47c7AG9uAM2fG6" target="_blank" rel="noopener noreferrer" style="color: #9fb0d3;">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«ã”å”åŠ›ãã ã•ã„</a>
        </div>
      </div>
    </aside>
  </div>
  
  <div id="noticeModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2>ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ±</h2>
      <div class="sub-header">ä»Šå›ã®ä¿®æ­£ãƒ»è¿½åŠ </div>
      <ul>
        <li>ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã‚’å®Ÿè£…ã€‚</li>
        <li>åŠ¹æœéŸ³ãƒ»BGMã‚’è¿½åŠ ã€‚</li>
        <li>ã°ã‚Œãªã„ãŸã‚ã®ã‚¿ãƒ–ã§ã®è¡¨ç¤ºå¤‰æ›´ã‚’è¿½åŠ ã€‚</li>
        <li>æ ã®å¢ƒç›®ãŒè¦‹ã‚„ã™ã„ã‚ˆã†ã«ä¿®æ­£ã€‚</li>
        <li>ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–ã€‚</li>
        <li>ã‚³ãƒ¼ãƒ‰å…¥åŠ›æ¬„ã‚’è¿½åŠ ã€‚</li>
      </ul>
      <div class="sub-header">è¿½åŠ äºˆå®š</div>
      <ul>
        <li>å¯¾æˆ¦æ©Ÿèƒ½</li>
      </ul>
      <div class="sub-header">æ³¨æ„</div>
      <p class="note" style="line-height: 1.6;">
        å…ˆç”Ÿã«æ³¨æ„ã•ã‚ŒãŸã‚Šã€å…ˆç”Ÿã«æ€’ã‚‰ã‚ŒãŸã‚Šã—ãŸå ´åˆã§ã‚‚åº•åŸæ°¸å’Œã¯è²¬ä»»ã‚’å–ã‚Šã¾ã›ã‚“ã€‚ã‚ã¨ã€éŸ³é‡æ³¨æ„
      </p>
      <div class="modal-footer">
        <button class="btn" id="closeNoticeBtn">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="cheatCodeModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2>ã‚³ãƒ¼ãƒ‰å…¥åŠ›</h2>
      <p class="note">ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
      <input type="password" id="cheatInput" class="cheat-input">
      <div class="modal-footer">
        <button class="btn" id="submitCheatBtn">å®Ÿè¡Œ</button>
        <button class="btn ghost" id="closeCheatBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <div id="shareModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2>ã‚²ãƒ¼ãƒ ã‚’å…±æœ‰</h2>
      <div id="qrcode"></div>
      <p class="note center">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã‹ã€ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚</p>
      <div class="url-container">
        <input type="text" id="urlInput" class="url-input" readonly>
        <button class="btn" id="copyUrlBtn">ã‚³ãƒ”ãƒ¼</button>
      </div>
      <div class="modal-footer">
        <button class="btn" id="closeShareBtn">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="rankingModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2>ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP 100</h2>
      <div class="center muted" id="personalBestContainer" style="margin-bottom: 16px; display: flex; align-items: center; justify-content: center; gap: 16px;">
        <span id="personalBestInRanking"></span>
        <button class="btn" id="recordHighScoreBtn" style="display: none;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«è¨˜éŒ²</button>
      </div>
      <div id="ranking-table-container">
        <table id="ranking-table">
          <thead>
            <tr>
              <th>é †ä½</th>
              <th>åå‰</th>
              <th>ã‚¹ã‚³ã‚¢</th>
            </tr>
          </thead>
          <tbody id="ranking-body"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn" id="closeRankingBtn">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <audio id="bgmAudio" src="bgm.mp3" loop></audio>
  <audio id="pushAudio" src="push.mp3"></audio>
  <audio id="delAudio" src="del.mp3"></audio>

  <script>
  // â˜…â˜…â˜…ã€é‡è¦ã€‘â˜…â˜…â˜…
  // Google Apps Scriptã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦å–å¾—ã—ãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URLã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
  const SPREADSHEET_URL = 'https://script.google.com/macros/s/AKfycbzQX8LSQXJgItJbQIPNsmYOyISq-HfFZuLmlcm9kUwE1cbunGRGRDR5L8HHrGsdXrWW/exec';

  let wasSkipPressed = false;

  window.addEventListener('DOMContentLoaded', () => {
    const loader = document.getElementById('loader'); const staffRollContainer = document.getElementById('staffRollContainer'); const loadComplete = document.getElementById('loadComplete'); const appContainer = document.getElementById('appContainer'); const skipBtn = document.getElementById('skipBtn'); const staffRollDuration = 14000; const logoDuration = 5000; const totalLoadTime = staffRollDuration + logoDuration; let logoTimer; let startTimer; const startApp = () => { if (loader.parentNode) { loader.classList.add('fade-out'); loader.addEventListener('animationend', () => { if (loader.parentNode) loader.remove(); document.body.style.overflow = 'auto'; }); appContainer.classList.remove('hidden'); appContainer.classList.add('fade-in'); initGame(); } }; const skipLoading = () => { wasSkipPressed = true; clearTimeout(logoTimer); clearTimeout(startTimer); startApp(); }; logoTimer = setTimeout(() => { staffRollContainer.classList.add('fade-out'); loadComplete.classList.remove('hidden'); loadComplete.classList.add('fade-in'); }, staffRollDuration); startTimer = setTimeout(startApp, totalLoadTime); skipBtn.addEventListener('click', skipLoading);
  });

  function initGame(){
    const ROWS = 8, COLS = 8, PIECE_COUNT = 3, BASE_POINTS_PER_LINE = 100;
    const COLORS = ['#FF6B6B', '#FFD166', '#06D6A0', '#4D96FF', '#9B5DE5', '#FF7AB6'];
    const SHAPES = [
        [[0,0]], [[0,0],[0,1]], [[0,0],[0,1],[0,2]], [[0,0],[0,1],[0,2],[0,3]],
        [[0,0],[1,0],[2,0]], [[0,0],[0,1],[1,0],[1,1]], [[0,0],[0,1],[1,0]],
        [[0,0],[0,1],[1,1]], [[0,0],[1,0],[1,1]], [[0,1],[1,0],[1,1],[1,2]],
        [[0,0],[0,1],[1,1],[1,2]], [[0,1],[0,2],[1,0],[1,1]], [[0,0],[1,1]],
        [[0,1],[1,0]], [[0,0],[1,0],[2,0],[2,1]], [[0,1],[1,1],[2,1],[2,0]],
        [[0,1],[1,1],[2,1],[0,0]], [[0,0],[1,0],[2,0],[0,1]]
    ];
    const BONUS_SHAPES = [ [[0,0]], [[0,0],[0,1]], [[0,0],[1,0]] ];
    const board = new Array(ROWS).fill(0).map(()=>new Array(COLS).fill(null));
    let pieces = [], selectedPieceIndex = -1, score = 0, best = 0, isOver = false, hintLocation = null, isFirstTurn = true, comboCount = 0, isSoundEnabled = true;

    const boardEl = document.getElementById('board'), piecesContainer = document.getElementById('piecesContainer'), scoreBox = document.getElementById('scoreBox'), highBox = document.getElementById('highBox'), currentScoreEl = document.getElementById('currentScore'), bestScoreEl = document.getElementById('bestScore'), restartBtn = document.getElementById('restartBtn'), hintBtn = document.getElementById('hintBtn'), gamePanel = document.getElementById('gamePanel'), noticeModal = document.getElementById('noticeModal'), closeNoticeBtn = document.getElementById('closeNoticeBtn'), cheatCodeModal = document.getElementById('cheatCodeModal'), cheatInput = document.getElementById('cheatInput'), submitCheatBtn = document.getElementById('submitCheatBtn'), closeCheatBtn = document.getElementById('closeCheatBtn'), hamburgerIcon = document.getElementById('hamburger-icon'), menuPanel = document.getElementById('menu-panel'), menuRestartBtn = document.getElementById('menu-restart-btn'), soundToggle = document.getElementById('sound-toggle'), menuShareBtn = document.getElementById('menu-share-btn'), shareModal = document.getElementById('shareModal'), qrcodeContainer = document.getElementById('qrcode'), urlInput = document.getElementById('urlInput'), copyUrlBtn = document.getElementById('copyUrlBtn'), closeShareBtn = document.getElementById('closeShareBtn'), bgmAudio = document.getElementById('bgmAudio'), pushAudio = document.getElementById('pushAudio'), delAudio = document.getElementById('delAudio'), menuRankingBtn = document.getElementById('menu-ranking-btn'), rankingModal = document.getElementById('rankingModal'), rankingBody = document.getElementById('ranking-body'), closeRankingBtn = document.getElementById('closeRankingBtn'), personalBestInRanking = document.getElementById('personalBestInRanking'), recordHighScoreBtn = document.getElementById('recordHighScoreBtn');

    function createBoard(){ boardEl.innerHTML = ''; for(let r=0;r<ROWS;r++){ for(let c=0;c<COLS;c++){ const cell = document.createElement('div'); cell.className = 'cell'; cell.dataset.r = r; cell.dataset.c = c; cell.setAttribute('role','button'); cell.setAttribute('aria-label',`ã‚»ãƒ« ${r+1},${c+1}`); cell.addEventListener('mouseenter', onCellMouseEnter); cell.addEventListener('mouseleave', onCellMouseLeave); cell.addEventListener('click', onCellClick); boardEl.appendChild(cell); } } renderBoard(); }
    function renderBoard(){ for(let r=0;r<ROWS;r++){ for(let c=0;c<COLS;c++){ const idx = r*COLS + c; const cell = boardEl.children[idx]; cell.innerHTML = ''; cell.classList.remove('hover-valid','hover-invalid'); if(board[r][c]){ const tile = document.createElement('div'); tile.className = 'tile'; tile.style.background = board[r][c].color; tile.style.transform = 'translateY(-6px)'; requestAnimationFrame(()=> tile.style.transform = 'translateY(0)'); cell.appendChild(tile); } } } scoreBox.textContent = `Score: ${score}`; currentScoreEl.textContent = score; highBox.textContent = `High: ${best}`; bestScoreEl.textContent = best; }
    function cloneShape(shape){ return shape.map(s=>[s[0],s[1]]); }
    let nextId = 1; function genPiece(isBonus = false){ const shapePool = isBonus ? BONUS_SHAPES : SHAPES; const shape = cloneShape(shapePool[Math.floor(Math.random()*shapePool.length)]); const color = COLORS[Math.floor(Math.random()*COLORS.length)]; return { shape, color, id: nextId++ }; }
    function replenishPieces() { if (pieces.length === 0) { const giveBonus = isFirstTurn && !wasSkipPressed; for(let i = 0; i < PIECE_COUNT; i++) { pieces.push(genPiece(giveBonus)); } isFirstTurn = false; } renderPieces(); }
    function renderPieces(){ piecesContainer.innerHTML = ''; pieces.forEach((p, i) => { const card = document.createElement('div'); card.className = 'piece-card'; if(i === selectedPieceIndex) card.classList.add('selected'); card.dataset.index = i; card.title = 'ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã—ã¦ç›¤é¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é…ç½®'; card.addEventListener('click', ()=>{ if(isOver) return; selectedPieceIndex = (selectedPieceIndex === i) ? -1 : i; renderPieces(); }); const mini = document.createElement('div'); mini.className = 'piece-grid'; const PREVIEW_GRID_SIZE = 4; const shape = p.shape; const rows = shape.map(s=>s[0]), cols = shape.map(s=>s[1]); const minR = Math.min(...rows), minC = Math.min(...cols); const maxR = Math.max(...rows), maxC = Math.max(...cols); const h = maxR - minR + 1, w = maxC - minC + 1; const offsetR = Math.max(0, Math.floor((PREVIEW_GRID_SIZE - h)/2)); const offsetC = Math.max(0, Math.floor((PREVIEW_GRID_SIZE - w)/2)); for(let rr=0; rr < PREVIEW_GRID_SIZE; rr++){ for(let cc=0; cc < PREVIEW_GRID_SIZE; cc++){ const mc = document.createElement('div'); mc.className = 'mini-cell'; const occupies = shape.some(s=>{ const sr = s[0]-minR + offsetR; const sc = s[1]-minC + offsetC; return sr===rr && sc===cc; }); if(occupies){ const t = document.createElement('div'); t.className = 'mini-cell tile'; t.style.background = p.color; mc.appendChild(t); } mini.appendChild(mc); } } card.appendChild(mini); piecesContainer.appendChild(card); }); }
    function cellEl(r,c){ if (r < 0 || r >= ROWS || c < 0 || c >= COLS) return null; return boardEl.children[r*COLS + c]; }
    function canPlace(piece, baseR, baseC){ for(const off of piece.shape){ const rr = baseR + off[0], cc = baseC + off[1]; if(rr < 0 || rr >= ROWS || cc < 0 || cc >= COLS || board[rr][cc]) return false; } return true; }
    function placePiece(piece, baseR, baseC) { if (isSoundEnabled) { pushAudio.currentTime = 0; pushAudio.play().catch(()=>{}); } checkGoodPlacement(piece, baseR, baseC); for (const off of piece.shape) { board[baseR + off[0]][baseC + off[1]] = { color: piece.color, id: piece.id }; } pieces = pieces.filter(p => p.id !== piece.id); selectedPieceIndex = -1; hintLocation = null; renderBoard(); const afterClearActions = () => { replenishPieces(); renderBoard(); checkSessionEnd(); }; const clearedLinesCount = clearFullLines(afterClearActions); if (clearedLinesCount > 0) { comboCount++; const gained = BASE_POINTS_PER_LINE * clearedLinesCount * clearedLinesCount * comboCount; score += gained; showFeedbackPopup(`+${gained}`); if(comboCount > 1) { setTimeout(() => showFeedbackPopup(`${comboCount} COMBO!`), 200); } let evaluationText = ''; if (clearedLinesCount === 2) evaluationText = 'Great!'; else if (clearedLinesCount === 3) evaluationText = 'Excellent!'; else if (clearedLinesCount >= 4) evaluationText = 'Amazing!'; if(evaluationText) { setTimeout(() => showFeedbackPopup(evaluationText), 400); } scoreBox.textContent = `Score: ${score}`; currentScoreEl.textContent = score; highBox.textContent = `High: ${best}`; bestScoreEl.textContent = best; } else { comboCount = 0; } }
    function showFeedbackPopup(text){ const popup = document.createElement('div'); popup.textContent = text; popup.className = 'feedback-popup'; gamePanel.appendChild(popup); popup.addEventListener('animationend', () => popup.remove()); }
    function clearFullLines(onClearComplete) { const rowsToClear = [], colsToClear = []; for (let r = 0; r < ROWS; r++) { if (board[r].every(cell => cell)) rowsToClear.push(r); } for (let c = 0; c < COLS; c++) { if (board.every(row => row[c])) colsToClear.push(c); } const total = rowsToClear.length + colsToClear.length; if (total === 0) { onClearComplete(); return 0; } if (isSoundEnabled) { delAudio.currentTime = 0; delAudio.play().catch(()=>{}); } const clearMarks = new Set(); rowsToClear.forEach(r => { for (let c = 0; c < COLS; c++) clearMarks.add(`${r},${c}`); }); colsToClear.forEach(c => { for (let r = 0; r < ROWS; r++) clearMarks.add(`${r},${c}`); }); clearMarks.forEach(key => { const [r, c] = key.split(',').map(Number); const el = cellEl(r, c); if (el && el.firstChild) el.firstChild.classList.add('clearing'); }); setTimeout(() => { clearMarks.forEach(key => { const [r, c] = key.split(',').map(Number); board[r][c] = null; }); onClearComplete(); }, 500); return total; }
    function anyPlacementPossible(){ for(const p of pieces) for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(canPlace(p,r,c)) return true; return false; }
    async function checkSessionEnd(){ if(!anyPlacementPossible()){ isOver = true; showEndScreen(); if(score > best) { await handleNewHighScore(score); } saveBest(); } }
    function showEndScreen(){ const overlay = document.createElement('div'); overlay.className = 'game-over'; overlay.id = 'gameOverOverlay'; overlay.innerHTML = `<div class="go-card"><div style="font-size:20px;font-weight:800;margin-bottom:8px">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµ‚äº†</div><div style="margin-bottom:8px">Score: <strong>${score}</strong></div><div style="display:flex;gap:8px;justify-content:center"><button class="btn" id="goRestart">ã‚„ã‚Šç›´ã™</button><button class="btn ghost" id="goClose">é–‰ã˜ã‚‹</button></div></div>`; gamePanel.appendChild(overlay); document.getElementById('goRestart').addEventListener('click', ()=>{ overlay.remove(); startNewSession(); }); document.getElementById('goClose').addEventListener('click', ()=>{ overlay.remove(); }); }
    function checkGoodPlacement(piece, r, c){ if(hintLocation && hintLocation.pieceId === piece.id && hintLocation.r === r && hintLocation.c === c){ showFeedbackPopup("ğŸ‘ Gleit"); } }
    function saveBest(){ best = Math.max(best, score); try { localStorage.setItem('blockblast_high', String(best)); } catch(e){} renderBoard(); }
    function loadBest(){ try{ best = Number(localStorage.getItem('blockblast_high')) || 0; } catch(e){ best = 0; } }
    function onCellMouseEnter(e){ if(isOver || selectedPieceIndex < 0  || selectedPieceIndex >= pieces.length) return; const r = Number(e.currentTarget.dataset.r), c = Number(e.currentTarget.dataset.c); const piece = pieces[selectedPieceIndex]; clearAllCellHover(); const valid = canPlace(piece, r, c); for(const off of piece.shape){ const rr = r + off[0], cc = c + off[1]; if(rr>=0&&rr<ROWS&&cc>=0&&cc<COLS){ const cel = cellEl(rr,cc); const tile = document.createElement('div'); tile.className = 'tile'; tile.style.opacity = '0.45'; tile.style.transform = 'scale(0.98)'; tile.style.background = piece.color; if (cel) { cel.classList.add(valid ? 'hover-valid' : 'hover-invalid'); cel.appendChild(tile); } } } }
    function onCellMouseLeave(e){ if(!isOver) clearAllCellHover(); }
    function clearAllCellHover(){ for(const cel of boardEl.children){ cel.classList.remove('hover-valid','hover-invalid'); for(let j = cel.children.length - 1; j >= 0; j--){ const child = cel.children[j]; if(child.style.opacity && Number(child.style.opacity) < 1){ cel.removeChild(child); } } } }
    function onCellClick(e){ if(isOver || selectedPieceIndex < 0 || selectedPieceIndex >= pieces.length) return; const r = Number(e.currentTarget.dataset.r), c = Number(e.currentTarget.dataset.c); const piece = pieces[selectedPieceIndex]; if(canPlace(piece, r, c)){ placePiece(piece, r, c); } else { e.currentTarget.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:220,iterations:1}); } }
    function provideHint(){ for(const [pi, p] of pieces.entries()){ for(let r=0;r<ROWS;r++){ for(let c=0;c<COLS;c++){ if(canPlace(p,r,c)){ p.shape.forEach(off => cellEl(r+off[0],c+off[1]).classList.add('hover-valid')); setTimeout(()=> clearAllCellHover(), 1000); selectedPieceIndex = pi; hintLocation = { pieceId: p.id, r, c }; renderPieces(); return; } } } } checkSessionEnd(); }
    function startNewSession(){ for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) board[r][c] = null; pieces = []; selectedPieceIndex = -1; score = 0; isOver = false; hintLocation = null; comboCount = 0; isFirstTurn = true; replenishPieces(); renderBoard(); const overlay = document.getElementById('gameOverOverlay'); if(overlay) overlay.remove(); menuPanel.classList.remove('open'); }
    
    async function handleCheatCode() { const code = cheatInput.value.trim().toLowerCase(); if (code === 'towa.soko0406') { const newScoreStr = prompt('æ–°ã—ã„ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', score); const newScore = parseInt(newScoreStr, 10); if (!isNaN(newScore)) { score = newScore; isOver = true; showEndScreen(); if (newScore > best) { await handleNewHighScore(newScore); } saveBest(); } else { alert('ç„¡åŠ¹ãªæ•°å€¤ã§ã™ã€‚'); } } else if (code === 'deletadata' || code === 'reset') { try { localStorage.removeItem('blockblast_high'); localStorage.removeItem('blockblast_sound'); localStorage.removeItem('blockblast_username'); alert('ä¿å­˜ã•ã‚ŒãŸå…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚'); location.reload(); } catch (e) { alert('ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); } } else { alert('ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚'); } cheatInput.value = ''; cheatCodeModal.classList.add('hidden'); }
    async function handleNewHighScore(newScore) { if (!SPREADSHEET_URL || SPREADSHEET_URL === 'ã“ã“ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URLã‚’è²¼ã‚Šä»˜ã‘') { return; } await new Promise(resolve => setTimeout(resolve, 500)); if (confirm(`ãƒã‚¤ã‚¹ã‚³ã‚¢é”æˆï¼\nã‚¹ã‚³ã‚¢: ${newScore}\nãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) { const savedName = localStorage.getItem('blockblast_username') || ''; const name = prompt('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã™ã‚‹åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ30æ–‡å­—ã¾ã§ï¼‰:', savedName); if (name && name.trim()) { localStorage.setItem('blockblast_username', name.trim()); await submitScore(name.trim(), newScore); } } }
    async function submitScore(name, scoreValue) { showFeedbackPopup('é€ä¿¡ä¸­...'); try { await fetch(SPREADSHEET_URL, { method: 'POST', mode: 'no-cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'saveScore', payload: { name, score: scoreValue } }) }); showFeedbackPopup('ç™»éŒ²ã—ã¾ã—ãŸï¼'); } catch (error) { console.error('ã‚¹ã‚³ã‚¢é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error); showFeedbackPopup('ç™»éŒ²å¤±æ•—'); } }
    
    async function showRanking() {
        personalBestInRanking.textContent = `ã‚ãªãŸã®ãƒã‚¤ã‚¹ã‚³ã‚¢: ${best.toLocaleString()}`;
        if (best > 0) { recordHighScoreBtn.style.display = 'inline-block'; } else { recordHighScoreBtn.style.display = 'none'; }
        rankingBody.innerHTML = '<tr><td colspan="3" class="center">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
        rankingModal.classList.remove('hidden');
        menuPanel.classList.remove('open');
        if (!SPREADSHEET_URL || SPREADSHEET_URL === 'ã“ã“ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URLã‚’è²¼ã‚Šä»˜ã‘') { rankingBody.innerHTML = '<tr><td colspan="3" class="center">ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</td></tr>'; return; }
        try { const response = await fetch(SPREADSHEET_URL); if (!response.ok) { throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`); } const result = await response.json(); if (result.status === 'success' && Array.isArray(result.data)) { const myName = localStorage.getItem('blockblast_username'); let myRankText = ''; if (myName) { const myRankIndex = result.data.findIndex(r => r.name === myName); if (myRankIndex !== -1) { myRankText = ` | ${myName}ã•ã‚“ã®é †ä½: ${myRankIndex + 1}ä½`; } } personalBestInRanking.textContent = `ã‚ãªãŸã®ãƒã‚¤ã‚¹ã‚³ã‚¢: ${best.toLocaleString()}${myRankText}`; if (result.data.length === 0) { rankingBody.innerHTML = '<tr><td colspan="3" class="center">ã¾ã èª°ã‚‚ç™»éŒ²ã—ã¦ã„ã¾ã›ã‚“ã€‚</td></tr>'; } else { rankingBody.innerHTML = result.data.map((row, index) => `<tr class="${(myName && row.name === myName) ? 'my-rank' : ''}"><td>${index + 1}ä½</td><td>${escapeHTML(row.name)}</td><td>${row.score.toLocaleString()}</td></tr>`).join(''); } } else { throw new Error(result.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); } } catch (error) { console.error('ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', error); rankingBody.innerHTML = `<tr><td colspan="3" class="center">ã‚¨ãƒ©ãƒ¼: ${error.message}</td></tr>`; }
    }
    
    function escapeHTML(str) { return str.replace(/[&<>'"]/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[tag] || tag)); }

    function init(){
      loadBest(); createBoard(); replenishPieces(); renderBoard(); noticeModal.classList.remove('hidden');
      restartBtn.addEventListener('click', startNewSession); hintBtn.addEventListener('click', provideHint);
      closeNoticeBtn.addEventListener('click', () => noticeModal.classList.add('hidden'));
      closeCheatBtn.addEventListener('click', () => cheatCodeModal.classList.add('hidden'));
      submitCheatBtn.addEventListener('click', handleCheatCode); cheatInput.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') handleCheatCode(); });
      hamburgerIcon.addEventListener('click', () => { menuPanel.classList.toggle('open'); }); menuRestartBtn.addEventListener('click', startNewSession);
      const savedSoundSetting = localStorage.getItem('blockblast_sound');
      if (savedSoundSetting !== null) { isSoundEnabled = savedSoundSetting === 'true'; soundToggle.checked = isSoundEnabled; }
      const playBGM = () => { if(isSoundEnabled) bgmAudio.play().catch(()=>{}); };
      document.body.addEventListener('click', playBGM, { once: true });
      soundToggle.addEventListener('change', (e) => { isSoundEnabled = e.target.checked; try { localStorage.setItem('blockblast_sound', isSoundEnabled); } catch(err) {} if (isSoundEnabled) { bgmAudio.play().catch(()=>{}); } else { bgmAudio.pause(); } });
      menuShareBtn.addEventListener('click', () => { const url = window.location.href; urlInput.value = url; qrcodeContainer.innerHTML = ''; QRCode.toCanvas(url, { width: 200, errorCorrectionLevel: 'H' }, function (err, canvas) { if (err) throw err; qrcodeContainer.appendChild(canvas); }); shareModal.classList.remove('hidden'); menuPanel.classList.remove('open'); });
      closeShareBtn.addEventListener('click', () => shareModal.classList.add('hidden')); copyUrlBtn.addEventListener('click', () => { urlInput.select(); navigator.clipboard.writeText(urlInput.value).then(() => { copyUrlBtn.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†!'; setTimeout(() => { copyUrlBtn.textContent = 'ã‚³ãƒ”ãƒ¼'; }, 2000); }); });
      menuRankingBtn.addEventListener('click', showRanking); closeRankingBtn.addEventListener('click', () => rankingModal.classList.add('hidden'));
      recordHighScoreBtn.addEventListener('click', async () => { if(best <= 0) return; const savedName = localStorage.getItem('blockblast_username') || ''; const name = prompt('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã™ã‚‹åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ30æ–‡å­—ã¾ã§ï¼‰:', savedName); if (name && name.trim()) { localStorage.setItem('blockblast_username', name.trim()); await submitScore(name.trim(), best); rankingModal.classList.add('hidden'); } });
      const originalTitle = document.title; const favicon = document.getElementById('favicon'); const originalFavicon = favicon ? favicon.href : ''; const fakeTitle = 'Google'; const fakeFavicon = 'https://www.google.com/favicon.ico';
      window.addEventListener('blur', () => { document.title = fakeTitle; if(favicon) favicon.href = fakeFavicon; }); window.addEventListener('focus', () => { document.title = originalTitle; if(favicon) favicon.href = originalFavicon; });
      window.addEventListener('keydown', (ev)=>{ if (!cheatCodeModal.classList.contains('hidden') || !shareModal.classList.contains('hidden') || !rankingModal.classList.contains('hidden')) return; if(ev.key === ' ') { ev.preventDefault(); cheatCodeModal.classList.remove('hidden'); cheatInput.focus(); } if(ev.key.toLowerCase() === 'r') startNewSession(); if(ev.key.toLowerCase() === 'h') provideHint(); if(['1','2','3'].includes(ev.key)){ const idx = Number(ev.key) - 1; if(idx < pieces.length){ selectedPieceIndex = (selectedPieceIndex === idx) ? -1 : idx; renderPieces(); } } });
    }

    init();
  }
  </script>
</body>
</html>
